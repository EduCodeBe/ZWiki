<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns:tal="http://xml.zope.org/namespaces/tal"
       xmlns:metal="http://xml.zope.org/namespaces/metal"
       metal:use-macro="here/main_template/macros/master">
<body>

<div metal:fill-slot="main"	  
     tal:define="DateTime python:modules['DateTime'].DateTime">

      <span metal:use-macro="python:here.wikipage_macros().macros['quickaccesskeys']" />

      <h1 tal:condition="here/inCMF">Mail subscription</h1>
      <span tal:condition="request/emailchanged|nothing">
        <!-- remember email address with a cookie like UserOptions -->
        <tal:dummy tal:define="r python:request.RESPONSE.setCookie(
                   'email',
                   request.email,
                   path='/',
                   expires=(here.ZopeTime() + 365).rfc822())
                   "/>
      </span>
      <form method="post" 
            enctype="multipart/form-data"
            action="page_url/subscribeform" 
            tal:attributes="action string:${here/page_url}/subscribeform"
            tal:define="
            email member/getUserName|request/email|nothing;
            pagesubscriber python:here.isSubscriber(email);
            wikisubscriber python:here.isWikiSubscriber(email);
            othersubscriptions python:here.otherPageSubscriptionsFor(email);
            split python:modules['string'].split;
            ">
        <p>
          You can subscribe to this page or to the whole wiki.
          Subscribers receive a copy of comments via email
          (but not general edits, unless enabled by the site admin).
          Or return to 
          <a href="page_url" tal:attributes="href here/page_url" 
             tal:content="here/title_or_id">Page name</a>.
        </p>

        <div tal:condition="here/inCMF">
          <input name="email" type="hidden" tal:attributes="value email" />
        </div>
        <div tal:condition="not:here/inCMF">
          Your email address:
          <input name="email" type="text" size=30 value="email" tal:attributes="value email" />
          <input name="emailchanged" type="hidden" value="1" />
          <input class="context"
                 type="submit" 
                 name="../subscribeform:method" 
                 value="Change" 
                 />
        </div>

        <div tal:condition="not:email">
          To subscribe, please configure your email address.
        </div>
        <table width="100%" cellpadding="2" cellspacing="1" border="0">
          <tr valign="top" tal:condition="email">
            <td valign="top" width="50%"
                tal:attributes="class python:
                (pagesubscriber and 'subscribed') or 'notsubscribed'">
              <br />
              <span tal:condition="pagesubscriber">
                <b>You are currently subscribed<br />
                to this page.</b>
              </span>
              <span tal:condition="not:pagesubscriber">
                You are currently not subscribed<br />
                to this page.
              </span>
              <br />
              <input tal:condition="pagesubscriber" 
                     class="standalone"
                     type="submit" 
                     name="../unsubscribe:method" 
                     value=" Unsubscribe from pagename " 
                     tal:attributes="value string: Unsubscribe from ${here/title_or_id} " 
                     />
              <input tal:condition="not:pagesubscriber" 
                     class="standalone"
                     type="submit" 
                     name="../subscribe:method" 
                     value=" Subscribe to pagename " 
                     tal:attributes="value string: Subscribe to ${here/title_or_id} " 
                     />
            </td>
            <td valign="top" width="50%"
                tal:attributes="class python:
                (pagesubscriber and 'subscribed') or 'notsubscribed'">
              <br />
              <span tal:condition="wikisubscriber">
                <b>You are currently subscribed<br />
                to the whole wiki.</b>
              </span>
              <span tal:condition="not:wikisubscriber">
                You are currently not subscribed<br />
                to the whole wiki.
              </span>
              <br />
              <input tal:condition="wikisubscriber" 
                     class="standalone"
                     type="submit" 
                     name="../wikiUnsubscribe:method" 
                     value="Unsubscribe from whole wiki" 
                     />
              <input tal:condition="not:wikisubscriber" 
                     class="standalone"
                     type="submit" 
                     name="../wikiSubscribe:method" 
                     value="Subscribe to whole wiki" 
                     />
            </td>
          </tr>
          <tr tal:condition="python:email and othersubscriptions">
            <td>
              You are subscribed to these other pages: <br />
              <a tal:repeat="pageid othersubscriptions" 
                 href="../pageid/subscribeform?email=email"
                 tal:attributes="href python:
                 '%s/%s/subscribeform?email=%s' % (
                 here.wiki_url(),pageid,here.urlquote(email))"
                 tal:content="python:here.pageWithId(pageid).title_or_id()"
              >pagename</a>
            </td>
            <td>
              &nbsp;
            </td>
          </tr>

          <tr>
            <td valign="top" width="50%">
              <br />
              Page subscribers:
              <br />
              <span tal:repeat="sub here/subscriberList">
                <span tal:replace="python:split(sub,'@')[0]"></span><br />
              </span>
            </td>
            <td valign="top" width="50%">
              <br />
              Wiki subscribers:
              <br />
              <span tal:repeat="sub here/wikiSubscriberList">
                <span tal:replace="python:split(sub,'@')[0]"></span>
                <br />
              </span>
            </td>
          </tr>

        </table>
      </form>

</div>
</body>
</html>
